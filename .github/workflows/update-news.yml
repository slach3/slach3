name: Atualizar Not√≠cias de Jogos

on:
  schedule:
    # Executa a cada 5 minutos
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    paths:
      - 'scraper.py'
      - '.github/workflows/update-news.yml'
      - 'docs/**'
      - 'requirements.txt'

jobs:
  update-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout c√≥digo com hist√≥rico completo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Executar scraper de not√≠cias
        run: python scraper.py
      
      - name: Mover arquivos para pasta docs
        run: |
          mv noticias.js docs/
          mv noticias.json docs/
      
      - name: Atualizar README
        run: |
          # Atualiza a data da √∫ltima atualiza√ß√£o
          sed -i "s/## ‚è∞ √öLTIMA ATUALIZA√á√ÉO.*$/## ‚è∞ √öLTIMA ATUALIZA√á√ÉO\n**$(date '+%Y-%m-%d - %H:%M:%S')**/" README.md
          
          # Adiciona entrada no hist√≥rico se houve mudan√ßas
          if git diff --name-only | grep -q "docs/noticias.js\|docs/noticias.json"; then
            sed -i "/## üìú Hist√≥rico de Desenvolvimento/a - [$(date '+%Y-%m-%d')] Atualiza√ß√£o autom√°tica de not√≠cias" README.md
          fi
      
      - name: Configurar Git
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions Bot"
      
      - name: Verificar mudan√ßas
        id: verify-changes
        run: |
          if git diff --name-only | grep -q "docs/noticias.js\|docs/noticias.json\|README.md"; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Mudan√ßas detectadas nos arquivos."
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "Nenhuma mudan√ßa detectada."
          fi
      
      - name: Commit e push das mudan√ßas
        if: steps.verify-changes.outputs.changes == 'true'
        run: |
          git add docs/noticias.js docs/noticias.json README.md
          git commit -m "Atualiza√ß√£o autom√°tica de not√≠cias e README - $(date '+%Y-%m-%d %H:%M:%S')"
          git push || git pull --rebase && git push
          echo "Arquivos atualizados com sucesso!"